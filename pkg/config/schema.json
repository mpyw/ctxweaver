{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/mpyw/ctxweaver/pkg/config/schema.json",
  "title": "ctxweaver configuration",
  "description": "Configuration file schema for ctxweaver",
  "type": "object",
  "properties": {
    "template": {
      "oneOf": [
        {
          "type": "string",
          "description": "Inline Go template for the statement to insert"
        },
        {
          "type": "object",
          "properties": {
            "file": {
              "type": "string",
              "minLength": 1,
              "description": "Path to a file containing the template"
            }
          },
          "required": ["file"],
          "additionalProperties": false
        }
      ],
      "description": "Go template for the statement to insert. Supports variables like {{.Ctx}}, {{.FuncName}}, etc."
    },
    "imports": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Import paths to add when the template is inserted"
    },
    "packages": {
      "$ref": "#/$defs/packages",
      "description": "Package filtering options"
    },
    "functions": {
      "$ref": "#/$defs/functions",
      "description": "Function filtering options"
    },
    "test": {
      "type": "boolean",
      "description": "Whether to process test files (*_test.go)",
      "default": false
    },
    "carriers": {
      "oneOf": [
        {
          "type": "array",
          "items": {
            "$ref": "#/$defs/carrier"
          },
          "description": "Simple form: array of custom carrier definitions (default carriers enabled)"
        },
        {
          "type": "object",
          "properties": {
            "custom": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/carrier"
              },
              "description": "Custom carrier definitions"
            },
            "default": {
              "type": "boolean",
              "description": "Whether to include default carriers (default: true)",
              "default": true
            }
          },
          "additionalProperties": false,
          "description": "Extended form: object with custom carriers and default toggle"
        }
      ],
      "description": "Context carrier configuration. Simple form: array of carriers. Extended form: {custom: [], default: bool}"
    },
    "hooks": {
      "$ref": "#/$defs/hooks",
      "description": "Shell commands to run before and after processing"
    }
  },
  "required": ["template", "packages"],
  "additionalProperties": false,
  "$defs": {
    "regexps": {
      "type": "object",
      "properties": {
        "only": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Include only items matching these regex patterns"
        },
        "omit": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Exclude items matching these regex patterns"
        }
      },
      "additionalProperties": false
    },
    "packages": {
      "type": "object",
      "properties": {
        "patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Package patterns to process (e.g., './...', './pkg/...')"
        },
        "regexps": {
          "$ref": "#/$defs/regexps",
          "description": "Regex patterns to filter packages by import path"
        }
      },
      "required": ["patterns"],
      "additionalProperties": false
    },
    "functions": {
      "type": "object",
      "properties": {
        "types": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["function", "method"]
          },
          "minItems": 1,
          "description": "Function types to process (function, method). Default: both."
        },
        "scopes": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["exported", "unexported"]
          },
          "minItems": 1,
          "description": "Function scopes to process (exported, unexported). Default: both."
        },
        "regexps": {
          "$ref": "#/$defs/regexps",
          "description": "Regex patterns to filter functions by name"
        }
      },
      "additionalProperties": false
    },
    "carrier": {
      "type": "object",
      "properties": {
        "package": {
          "type": "string",
          "description": "Import path of the package containing the type"
        },
        "type": {
          "type": "string",
          "description": "Name of the type"
        },
        "accessor": {
          "type": "string",
          "description": "Expression to extract context.Context from the type (e.g., '.Context()', '.Request.Context()')"
        }
      },
      "required": ["package", "type"],
      "additionalProperties": false
    },
    "hooks": {
      "type": "object",
      "properties": {
        "pre": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Shell commands to run before processing"
        },
        "post": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Shell commands to run after processing"
        }
      },
      "additionalProperties": false
    }
  }
}
